name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs: 
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

    # - name : Docker Build
    # run: docker build -t tcp_scanner .

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y netcat-openbsd

      - name: CMake build
        run: |
          mkdir build
          cd build
          cmake ..
          cmake --build .

      - name: Test 1 - Basic compilation test
        run: |
          cd build
          ./tcp_scanner 127.0.0.1 22 22 || echo "Test completed (port may be closed)"

      #  - name: Test 2 - Invalid IP test (should fail)
      #   run: |
      #     cd build
      #     if ./tcp_scanner 999.999.999.999 80 80; then
      #       echo "Test failed: Invalid IP should return error"
      #       exit 1
      #     else
      #       echo "Test passed: Invalid IP correctly rejected"
      #     fi

      - name: Test 3 - Invalid arguments test
        run: |
          cd build
          if ./tcp_scanner; then
            echo "Test failed: No arguments should show usage"
            exit 1
          else
            echo "Test passed: Usage message displayed correctly"
          fi

      - name: Test 4 - Start mock server and test scanning
        run: |
          cd build
          # Start a simple HTTP server on port 8080 in background
          echo "Starting mock HTTP server..."
          nc -l -p 8080 -e /bin/echo -e "HTTP/1.1 200 OK\r\nServer: TestServer\r\n\r\n" &
          SERVER_PID=$!
          sleep 2
          
          # Test scanning the open port
          echo "Testing scan of open port 8080..."
          ./tcp_scanner 127.0.0.1 8080 8080
          
          # Kill the server
          kill $SERVER_PID 2>/dev/null || true
          echo "Test passed: Mock server test completed"

      - name: Test 5 - Port range test
        run: |
          cd build
          echo "Testing port range scanning..."
          ./tcp_scanner 127.0.0.1 22 25 || echo "Port range test completed"
          echo "Test passed: Port range scanning works"

      - name: Test 6 - Localhost services test
        run: |
          cd build
          echo "Testing common localhost services..."
          ./tcp_scanner 127.0.0.1 22 22 || echo "SSH port test completed"
          ./tcp_scanner 127.0.0.1 80 80 || echo "HTTP port test completed"
          echo "Test passed: Localhost services test completed"

      - name: Test 7 - Performance test
        run: |
          cd build
          echo "Testing scanner performance (10 closed ports)..."
          timeout 30s ./tcp_scanner 127.0.0.1 12340 12349 || echo "Performance test completed"
          echo "Test passed: Performance test within acceptable time"

      - name: Test 8 - Network timeout test
        run: |
          cd build
          echo "Testing network timeout with unreachable IP..."
          timeout 10s ./tcp_scanner 192.0.2.1 80 80 || echo "Timeout test completed as expected"
          echo "Test passed: Network timeout handled correctly"

      - name: Run CMake CTest
        run: |
          cd build
          ctest --output-on-failure --verbose
  deploy:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Application
        run: |
          echo "Deploying application..."
          # Add your deployment commands here
          # For example, you might use scp to copy files to a server
          # scp -r ./build user@server:/path/to/deploy
          echo "Deployment complete."
